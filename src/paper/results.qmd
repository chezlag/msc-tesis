# Resultados

```{r lib-fcn}
library(groundhog)
pkgs <- c(
  "arsenal",
  "collapse",
  "data.table",
  "did",
  "fixest",
  "forcats",
  "fst",
  "ggplot2",
  "ggsci",
  "gtsummary",
  "kableExtra",
  "magrittr",
  "modelsummary",
  "purrr",
  "rlist",
  "stringr"
)
groundhog.library(pkgs, "2024-01-15")

ROOT <- ""
if (grepl("src/paper", getwd())) ROOT <- "../../"
awd <- \(x) paste0(ROOT, x)

source(paste0(ROOT, "src/lib/tidy_did.R"))
source(paste0(ROOT, "src/lib/theme_set.R"))
```

```{r read-estimates}
# estimation specifications
estname <- c("S1.bal.ctrl")

# read base CS estimations
main_est_list <-
  awd(paste0("out/analysis/did_yearly_", estname, ".RDS")) |>
  map(readRDS)
# assign names
names(main_est_list) <- estname
stubnames <- c(
  "deductPurchases",
  "Revenue",
  "vatPurchases",
  "vatSales",
  "vatPaid"
)
varlist <- c(
  paste0("Scaled1", stubnames, "K"),
  paste0("Scaled2", stubnames, "K")
)
main_est_list <- map(main_est_list, \(x) set_names(x, varlist))

# read simple overall att
filelist <- estname %>% paste0(ROOT, "out/analysis/did_yearly_", ., "_aggte.simple.RDS")
simple_est <- lapply(filelist, readRDS)
simple <- map(
  filelist,
  ~ .x %>%
    readRDS() %>%
    map(possibly(tidy_did, NULL)) %>%
    reduce(rbind) %>%
    setDT() %>%
    .[, variable := str_remove_all(y.name, "^Scaled[12]|K$") %>% as_factor()]
)
# read dynamic att
filelist <- str_replace(filelist, "simple", "dynamic")
dynamic_est <- map(filelist, readRDS)
dynamic <- map(
  filelist,
  ~ .x %>%
    readRDS() %>%
    map(possibly(tidy_did, NULL)) %>%
    reduce(rbind) %>%
    setDT() %>%
    .[, variable := str_remove_all(y.name, "^Scaled[12]|K$") %>% as_factor()]
)
# name estimations
names(simple) <- estname
names(dynamic) <- estname
names(simple_est) <- estname
names(dynamic_est) <- estname
# set data.table
walk(simple, setDT)
walk(dynamic, setDT)
# add column with specification name
walk2(simple, estname, ~ .x[, sample := .y])
walk2(dynamic, estname, ~ .x[, sample := .y])
```

```{r read-data}
samples <- 
  read_fst(awd("out/data/samples.fst"), as.data.table = TRUE)
cohorts <-
  read_fst(awd("out/data/cohorts.fst"), as.data.table = TRUE)
dts <-
  read_fst(awd("out/data/firms_static.fst"), as.data.table = TRUE) %>%
  .[samples[(activeBusinessAnyT)], on = "fid"] %>%
  merge(cohorts, by = "fid")
dty <- 
  read_fst(awd("out/data/firms_yearly.fst"), as.data.table = TRUE) %>%
  .[samples[(activeBusinessAnyT)], on = "fid"] %>%
  merge(cohorts, by = "fid")
```

## Resultados principales

```{r tbl-main-overall-att}
#| tbl-cap: Efecto de tratamiento agregado. Panel balanceado.
main_est <- readRDS(awd("out/analysis/did_yearly_S1.bal.ctrl_aggte.simple.RDS"))
main_est_tbl <- main_est %>%
  map(possibly(tidy_did_list, NULL)) %>%
  list.filter(str_detect(tidy$y.name[[1]], "^Scaled1"))
colnames <- list.cases(main_est_tbl, tidy$y.name, sorted = FALSE)
names(main_est_tbl) <- str_remove_all(colnames, "^Scaled1|K$")
var_regex <- "deductPurchases|Revenue|vatPurchases|vatSales|vatPaid"
ar <- data.frame("Mean Y pre-2011",
                 lapply(grep(var_regex, colnames, value = TRUE),
                        \(x) dty[inSample1 &
                                   G1 < 2016 & year <= 2011, fmean(get(x), na.rm = TRUE)]))
main_est_tbl %>%
  list.match(var_regex) %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation"), 
    add_rows = ar
  )
```

### Recepción de e-facturas y compras reportadas

En primer lugar, muestro evidencia en apoyo del supuesto de tendencias paralelas en las compras declaradas, un requerimiento para la identificación en el diseño de diferencias en diferencias. Primero, realizo un test de Wald de significación conjunta de los $ATT(g,t)$ previos al tratamiento y no rechazo que sean conjuntamente iguales a cero, con un p-valor de `r main_est_list$S1.bal.ctrl$Scaled1deductPurchasesK$Wpval`. Segundo, la @fig-cost-dynamic presenta la agregación de los $ATT(g,t)$ respecto al tiempo desde el tratamiento, un gráfico equivalente al estudio de eventos. Se observa que las bandas de confianza de los eventos pre-tratamiento incluyen al cero en todos los casos. Si bien ninguno de estos tests confirma que el supuesto de tendencias paralelas se cumple, si dota de mayor credibilidad al diseño seleccionado: indica que, en los años antes de recibir e-facturas, los compras reportados por tratados y controles venían evolucionando en paralelo.

Formalizo esta evidencia en la primera columna de la @tbl-main-overall-att, donde presento la agregación de los $ATT(g,t)$ que aproxima el efecto promedio de la política para todos los grupos, para todos los períodos post-tratamiento. En conjunto, la recepción de e-facturas genera un aumento promedio en las compras reportadas de \$`r main_est_tbl$deductPurchases$tidy$estimate |> round(3)` por peso de facturación declarada en 2009–2010. En términos porcentuales respecto a la media pre-2011, representa un aumento de `r (main_est_tbl$deductPurchases$tidy$estimate/ ar[[2]])  |> round(2) * 100`.

```{r fig-cost-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre costos reportados

tidy <- 
  readRDS(awd("out/analysis/did_yearly_S1.bal.ctrl_aggte.dynamic.RDS")) |>
  map(possibly(tidy_did)) |>
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := str_remove_all(y.name, "^Scaled[12]|K$") %>% as_factor()]

tidy[y.name == "Scaled1deductPurchasesK"] %>%
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  labs(caption = "[ 95% Simult. CI ]")
```

### Recepción de e-facturas e ingresos reportados

En segundo lugar, exploro los ingresos reportados. Al igual que en la sección anterior, comienzo por verificar la existencia de tendencias paralelas previas al tratamiento. Nuevamente, el test de significación conjunta no resulta estadísticamente significativo [^pv2] y la @fig-revenue-dynamic muestra que los coeficientes agregados al estilo de un estudio de eventos no resultan individualmente significativos antes del inicio del tratamiento.

[^pv2]: El p-valor del test de Wald de significación conjunta es `r main_est_list$S1.bal.ctrl$Scaled1RevenueK$Wpval`.

En la segunda columna de la @tbl-main-overall-att muestro la estimación del efecto agregado promedio sobre los tratados. La estimación puntual es de \$`r main_est_tbl$Revenue$tidy$estimate |> round(3)` por peso de facturación declarada en 2009–2010 –un `r (main_est_tbl$Revenue$tidy$estimate/ ar[[3]])  |> round(2) * 100`% de la media pre-2011–, pero no es significativa al 95%.

```{r fig-revenue-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre ingresos reportados

tidy[y.name == "Scaled1RevenueK"] |>
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .125
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(limits = c(-3.1, 2.1), breaks = -4:2) +
  labs(caption = "[ 95% Simult. CI ]")
```

### Recepción de e-facturas y pago de IVA

Por último analizo el pago anual de IVA, junto con IVA compras e IVA ventas declarados por las firmas. Cabe aclarar que aunque IVA compras e IVA ventas tienen un vínculo directo con costos y ventas reportados, respectivamente, dicho vínculo no es lineal. Hay productos y servicios que están sujetos a distintas tasas de IVA, lo cual crea no-linealidades en la relación entre IVA compras y costos (e IVA ventas e ingresos). Por otra parte, el IVA adeudado surge principalmente de la diferencia entre IVA ventas e IVA compras; pero la firma toma decisiones respecto a como afrontar esa deuda.

La @fig-vat-dynamic ilustra los efectos de tratamiento dinámicos sobre IVA compras (panel 1), IVA ventas (panel 2) y pago de IVA (panel 3). En ningún caso hay efectos significativos antes del tratamiento y rechazo el test de significación conjunta de los coeficientes pre-tratamiento[^pv3].  Hay efectos significativos en el segundo período luego del tratamiento, tanto en IVA compras e IVA ventas.

[^pv3]: El p-valor del test es de `r main_est_list$S1.bal.ctrl$Scaled1vatPurchasesK$Wpval` para IVA Compras, `r main_est_list$S1.bal.ctrl$Scaled1vatSalesK$Wpval` para IVA Ventas, y `r main_est_list$S1.bal.ctrl$Scaled1vatPaidK$Wpval` para pago de IVA.

Las últimas tres columnas de la @tbl-main-overall-att muestran el efecto agregado promedio sobre los tratados, para cada una de estas tres variables. La recepción de e-facturas tiene un impacto estadísticamente significativo sobre IVA compras, IVA ventas y sobre los pagos de IVA. La estimación puntual del efecto es de \$`r main_est_tbl$vatPurchases$tidy$estimate |> round(3)`, \$`r main_est_tbl$vatSales$tidy$estimate |> round(3)`, y \$`r main_est_tbl$vatPurchases$tidy$estimate |> round(3)` por peso de facturación rezagada, respectivamente. Los efectos representan `r (main_est_tbl$vatPurchases$tidy$estimate/ ar[[4]])  |> round(2) * 100`%, `r (main_est_tbl$vatSales$tidy$estimate/ ar[[5]])  |> round(2) * 100`% y `r (main_est_tbl$vatPaid$tidy$estimate/ ar[[6]])  |> round(2) * 100`% de la media de cada una de las variables pre-2011.

```{r fig-vat-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre componentes del IVA

tidy[y.name %in% (c("vatSales", "vatPurchases", "vatPaid") %>% 
                    paste0("Scaled1", ., "K"))] %>%
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  # geom_line(size = 1) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .3) +
  geom_errorbar(aes(ymin = conf.low,
                    ymax = conf.high),
                width = .2) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  facet_wrap( ~ variable, nrow = 3) +
  labs(caption = "[ 95% Simult. CI ]")
```

## Heterogeneidades

En esta sección analizo heterogeneidades en los efectos de tratamiento, de acuerdo al tamaño y al sector de las firmas. Presento en cada caso evidencia para apoyar el supuesto de tendencias paralelas, ya entre cuartiles de tamaño o entre sectores de actividad. Luego, muestro los efectos de tratamiento agregados, por sector y por tamaño de la firma.

### Heterogeneidad por tamaño de las firmas

```{r compute-size-quartiles}
size_quartiles <- dty[(inSample1), quantile(Scaler1, probs = seq(0, 1, 0.25), na.rm = TRUE)]
dty[(inSample1), sizeQuartile := cut(Scaler1, breaks = size_quartiles, labels = 1:4)]
```

Para estudiar heterogeneidades en los efectos de tratamiento por tamaño, defino cuartiles de facturación pre-tratamiento para las firmas de la muestra principal. Las firmas del primer cuartil tienen una facturación pre-tratamiento menor a \$`r (size_quartiles[2] / 1e6) |> round(digits = 1)`M y las del cuarto cuartil una facturación superior a \$`r (size_quartiles[2] / 1e6) |> round(digits = 1)`M. Estudio las compras y ventas reportadas y los pagos de IVA; realizando estimaciones del efecto de la recepción de e-facturas dentro de cada cuartil. En todas las estimaciones controlo por cuartiles de edad de la firma y nivel de activos pre-tratamiento, y por sector de actividad. 

En primer lugar, testeo la existencia de tendencias diferenciales pre-tratamiento entre tratados y controles. La @fig-by.size-dynamic muestra los efectos de tratamiento dinámicos. Prácticamente ninguno de los coeficientes pre-tratamiento resulta signifcativo y no son conjuntamente significativos al realizar un test de Wald, lo cual aporta evidencia a favor del supuesto de tendencias paralelas.

La @fig-by.size-overall sintetiza las estimaciones de los efectos agregados de tratamiento por cuartil de facturación pre-tratamiento. Se observa que la recepción de e-facturas no se asocia a variaciones en las compras ni ventas reportadas en ninguno de los cuartiles. Por otra parte, sí hay efectos significativos sobre el pago de IVA en el primer y tercer cuartil. El efecto es decreciente entre cuartiles, con estimaciones puntuales de \$0.013 por peso de facturación pre-tratamiento en el primer cuartil y \$0.005 en el tercero. El efecto en el primer cuartil más que duplica al estimado para la muestra completa, mientras que el estimado en el tercer cuartil está por debajo.

```{r fig-by.size-overall}
#| fig-cap: Efecto de tratamiento agregado por cuartiles de facturación pre-tratamiento. Panel balanceado.

est_size <- readRDS(awd("out/analysis/did_yearly_by.size_S1.bal.ctrl.RDS"))

simple_size <-
  readRDS(awd(
    "out/analysis/did_yearly_by.size_S1.bal.ctrl_aggte.simple.RDS"
  ))

tidy_size <- simple_size %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := str_remove_all(y.name, "^Scaled1|K$") %>%
    as_factor()]

quantlist <- paste0("Quartile ", 1:4)
nvars <- tidy_size[, .N, y.name] %>%
  dim() %>%
  .[1]
tidy_size[, sizeQuartile := rep(quantlist, nvars) %>% as_factor()]

varlist <- c("deductPurchases", "Revenue", "vatPaid")
tidy_size[variable %in% varlist] %>%
  ggplot(aes(x = estimate, y = sizeQuartile, color = variable)) +
  geom_point(
    size = 2,
    position = position_dodge(width = .5)
  ) +
  geom_errorbarh(
    aes(
      xmin = conf.low,
      xmax = conf.high
    ),
    height = .5,
    position = position_dodge(width = .5)
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed"
  ) +
  coord_cartesian(xlim = c(-0.05, 0.5)) +
  ggsci::scale_color_futurama() +
  labs(y = NULL, color = NULL)
```

### Heterogeneidad por sector de actividad

Para analizar potenciales heterogeneidades en los efectos de tratamiento por sector de actividad, realizo estimaciones restringiendo iterativamente la muestra a seis sectores de actividad: Construcción, Servicios, Comercio minorista, Industria manufacturera, Comercio mayorista, y Actividades primarias. Estudio los efectos de e-facturas sobre las tres variables principales de análisis: costos reportados, ingresos reportados y pagos de IVA. En cada caso, controlo por cuartiles de facturación pre-tratamiento, cuartiles de activos pre-tratamiento y cuartiles de edad de la firma. En primer lugar, testeo la existencia de tendencias previas a la interna de cada sector de actividad y para cada variable de interés. El test de Wald de significación conjunta no rechaza que los coeficientes pre-tratamiento sean iguales a cero en ninguno de los casos.

La @fig-by.industry-overall presenta los efectos de tratamiento promedio sobre cada una de las variables dentro de cada sector. Se observa que la recepción de e-facturas tiene efectos significativos únicamente en algunos sectores y en algunas variables. Primero, destaca que no se observen efectos significativos sobre las compras reportadas en ningún sector de actividad analizado individualmente. Por el contrario, si se observa un incremento en el ingreso reportado en las firmas insertas en el comercio minorista, las manufacturas y las actividades primarias. La estimación puntual del efecto oscila entre \$0.09–\$0.26 por peso de facturación pre-tratamiento. En cuanto a los pagos de IVA, solo el sector servicios presenta un aumento significativo luego de que comienza la recepción de e-facturas. En este último caso, la estimación puntual del efecto es de \$0.015 por peso de facturación pre-tratamiento, duplicando el efecto estimado para la muestra total.

```{r fig-by.industry-overall}
#| fig-cap: Efecto de tratamiento agregado por sector de actividad. Panel balanceado.

simple_ind <- readRDS(awd("out/analysis/did_yearly_by.industry_S1.bal.ctrl_aggte.simple.RDS"))

tgtcols <- c("deductPurchases", "Revenue", "vatPaid")

tidy_ind <- simple_ind %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := str_remove_all(y.name, "^Scaled1|K$") %>%
    as_factor()]

industrylist <- c("Construction", "Services", "Retail trade", "Manufacturing", "Wholesale", "Primary activities")
nvars <- tidy_ind[, .N, y.name][N == length(industrylist)] %>%
  dim() %>%
  .[1]
exclvar <- tidy_ind[, .N, y.name][N < length(industrylist)]
tidy_ind[y.name %nin% exclvar, sector := rep(industrylist, nvars) %>% as_factor()]


p1 <- tidy_ind[variable %in% tgtcols & !is.na(sector)] %>%
  ggplot(aes(x = estimate, y = sector, color = variable)) +
  geom_point(size = 2,
             position = position_dodge(width = .5)) +
  geom_errorbarh(
    aes(xmin = conf.low,
        xmax = conf.high),
    height = .5,
    position = position_dodge(width = .5)
  ) +
  geom_vline(xintercept = 0,
             linetype = "dashed") +
  coord_cartesian(xlim = c(-0.3, 0.66)) +
  ggsci::scale_color_futurama() +
  labs(y = NULL, color = NULL)

# Add number of observations per industry
industrylist <-
  c(
    "Construction",
    "Services",
    "Retail trade",
    "Manufacturing",
    "Wholesale",
    "Primary activities"
  )
dty[sector == "Agriculture, forestry, fishing, mining and quarrying", sector := "Primary activities"]
nobs <- dty[(inSample1) & sector %in% industrylist, .N, sector] %>%
  .[, estimate := .6] %>%
  .[, label := paste0("N = ", N)]

# Final plot
p1 +
  geom_text(data = nobs, aes(label = label), color = "black")
```

```{r include = FALSE}
est_ind <- readRDS(awd("out/analysis/did_yearly_by.industry_S1.bal.ctrl.RDS"))
names(est_ind) <- tidy_ind[, str_c(variable, ".", sector)]
map(est_ind, \(x) x$Wpval)
```

## Margen extensivo

En esta sección presento evidencia sobre los efectos de la recepción de e-facturas en el margen extensivo. Estudio salidas de la muestra, cambios en la franja de renta ficta de IRAE, y cambios de declaraciones fictas a declaraciones reales de la actividad de la firma. Aplico el diseño de @callawayDifferenceinDifferencesMultipleTime2021 utilizando variables dependientes binarias para aproximarnos a las probabilidades de los eventos mencionados. Utilizo distintas muestras en cada subsección, detallando las diferencias en cada caso.

### Salidas

```{r read-est-ext.survival}
est_survival <- readRDS(awd("out/analysis/did_yearly_ext.survival_S3.bal.ctrl.RDS"))
colnames <- est_survival |> lapply(\(x) x$DIDparams$yname) |> unlist()
names(est_survival) <- colnames
```

En primer lugar, estudio el impacto de la recepción de e-facturas sobre las salidas de las firmas de los registros tributarios. Para ello cambio la muestra: utilizo un panel de firmas balanceado en el período antes del primer tratamiento, pero permito salidas luego del inicio del tratamiento. Balanceo el panel artificialmente, de forma que las firmas aparezcan en todos los períodos a pesar de su salida. Luego cuantifico el impacto de la recepción de e-facturas sobre la probabilidad de que la firma registre distintos tipos de actividad con la autoridad tributaria. Considero como variables dependientes la probabilidad de que la firma presente el formulario 2148 (asociado al pago de IRAE e IPAT), el formulario 2178 (asociado al pago de IVA), y la probabilidad de que la firma registre un pago de IVA en el período.

La @fig-ext.survival-dynamic muestra los efectos de tratamiento dinámicos para cada una de las variables mencionadas. Ninguno de los coeficientes pre-tratamiento resulta significativo, y en ningún caso encuentro que los coeficientes pre-tratamiento sean conjuntamente significativos. [^wald-survival]

[^wald-survival]: Los p-valores del test de Wald para la probabilidad de presentar el formulario 2148, el formulario 2178 y de realizar algún pago de IVA son `r est_survival$in214$Wpval`, `r est_survival$in217$Wpval`, y `r est_survival$anyVatPaid$Wpval`, respectivamente.

La @tbl-ext.survival-overall-att formaliza la evidencia gráfica y presenta los efectos agregados de tratamiento sobre cada una de las probabilidades mencionadas. Se observa que la recepción de e-facturas tiene una asociación negativa con la supervivencia (formal) de las firmas, aunque su magnitud es limitada y los efectos son significativos solamente al 10% de confianza. La recepción de e-facturas reduce, en promedio, 0.8 puntos porcentuales la probabilidad de presentar el formulario 2148 y 0.9 puntos porcentuales la probabilidad de presentar el formulario 2178. Por otra parte, no aparecen efectos significativos sobre la probabilidad de que las firmas realicen pagos de IVA.

```{r fig-ext.survival-dynamic}
est_dyn_survival <-
  readRDS(awd(
    "out/analysis/did_yearly_ext.survival_S3.bal.ctrl_aggte.dynamic.RDS"
  ))

est_survival <- 
  readRDS(awd(
    "out/analysis/did_yearly_ext.survival_S3.bal.ctrl.RDS"
  ))

tidy <- est_dyn_survival %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>% 
  .[, variable := as_factor(y.name)]

tidy[variable %in% c("in214", "in217", "anyVatPaid")] %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2, 
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks = -5:4) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.survival-overall-att}
#| tbl-cap: Efecto agregado de la recepción de e-facturas sobre probabilidad de supervivencia.

estlist <- readRDS(awd("out/analysis/did_yearly_ext.survival_S3.bal.ctrl_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list)
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- str_flatten(colnames, collapse = "|")
# ar <- data.frame("Mean Y pre-2011",
#                  lapply(grep(var_regex, colnames, value = TRUE),
#                         \(x) dtycj[
#                                    G1 < 2016 & year <= 2011, fmean(get(x), na.rm = TRUE)]))
tbl[c("in214", "in217", "anyVatPaid")] %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation")
  )
```

### Cambios de franja de renta ficta

```{r read-est-ext.bracket}
est_bracket <- readRDS(awd("out/analysis/did_yearly_ext.bracket_S1.bal.ctrl.RDS"))
colnames <- est_bracket |> lapply(\(x) x$DIDparams$yname) |> unlist()
names(est_bracket) <- colnames
```

Como ya mencioné, utilizo una muestra de firmas que presentan declaraciones fictas de actividad, en las cuales reportan únicamente sus ingresos. Luego, la DGI adjudica a las firmas una ganancia ficta y aplica sobre esta una tasa de 25% para calcular el IRAE adeudado. Una consecuencia de esto, como se observaba en la subsección anterior, es que este subconjunto de firmas reporta implícitamente ganancias en todos los períodos –y paga IRAE por estos–.

La renta ficta no se calcula de forma lineal. La tasa de rentabilidad ficta varía por tramos de facturación: para las firmas que facturan menos de 2M de UI es de 13.2%, para las que facturan entre 2M y 3M de UI es de 36%, y para las que facturan más de 3M de UI es de 48%. El régimen busca incentivar a las firmas a hacer declaraciones reales de su actividad luego de que superan cierto volumen de facturación.

El diseño, sin embargo, genera saltos discretos en la deuda tributaria de las firmas. Para ilustrar, en el márgen, una firma que factura 1:999.999 UI debería pagar 66.000 UI por IRAE, mientras que facturando 2:000.001 UI pasaría a pagar 180.000 UI, casi triplicando su deuda tributaria. Es esperable que las firmas respondan a estos incentivos y la @fig-dens-trunover-fict muestra que lo hacen, concentrando sus declaraciones justo por debajo y por encima del punto de corte de 2M UI. [^bunch_excede]

[^bunch_excede]: Si bien podríamos explotar esta discontinuidad con un diseño de *bunching*, excede el alcance actual de este trabajo.

En esta subsección, exploro si la recepción de e-facturas tiene un impacto suficientemente fuerte como para empujar a las firmas a cambiar de tramo de declaración. Primero, presento evidencia que apoye el supuesto de tendencias paralelas en la probabilidad de cambiar de tramo de renta ficta (@fig-ext.bracket-dynamic). Testeo el cambio de tramo con cuatro especificaciones, utilizando (i) la probabilidad de pasar del primer al segundo tramo de renta ficta; (ii) la probabilidad de pasar a un tramo mayor de un período al siguiente; (iii) la probabilidad de pasar a un tramo menor de un período al siguiente; y (iv) la probabilidad de cambiar de tramo, independientemente de si implica una mayor o menor deuda tributaria. Ninguno de los coeficientes pre- ni post- tratamiento es significativamente distinto de cero al 95%. A su vez, el test de Wald no rechaza que los coeficientes pre-tratamiento sean conjuntamente iguales a cero en todas las variables analizadas. [^wald-bracket]

[^wald-bracket]: Los p-valores del test de Wald son `r est_bracket$bracket1to2$Wpval`, `r est_bracket$bracketShiftUp$Wpval`, `r est_bracket$bracketShiftDown$Wpval`, `r est_bracket$bracketShiftAny$Wpval`.

La @tbl-ext.bracket-overall-att presenta los efectos de tratamiento agregados. La recepción de e-facturas tiene una asociación positiva con cambios a tramos superiores de renta ficta y negativa con el pasaje a tramos inferiores. Sin embargo, la relación es débil y ninguno de los coeficientes resulta estadísticamente significativo. En otras palabras, la recepción de e-facturas no parece tener un efecto de suficiente magnitud sobre el ingreso reportado como para llevar a las firmas a cambiar de tramo de facturación. El resultado es coherente con lo hallado al analizar el ingreso reportado, ya que tampoco aparecían efectos significativos de la e-factura sobre dicha variable en términos continuos. Considerando, a su vez, la importante variación en la deuda tributaria que implicaría un cambio de tramo, la firma tiene incentivos fuertes para evitar que esto ocurra.

```{r fig-ext.bracket-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre probabilidad de cambiar de franja de renta ficta.
est_dyn <- readRDS(awd("out/analysis/did_yearly_ext.bracket_S1.bal.ctrl_aggte.dynamic.RDS"))
tidy <- est_dyn %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := as_factor(y.name)]
tidy[str_detect(variable, "bracketShift|bracket1to2")] %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2,
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks  = -6:4, ) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.bracket-overall-att}
#| tbl-cap: Efecto de tratamiento agregado sobre probabilidad de cambiar de franja de renta ficta.
estlist <- readRDS(awd("out/analysis/did_yearly_ext.bracket_S1.bal.ctrl_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list)
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- "bracketShift|bracket1to2"
tbl %>%
  list.match(var_regex) %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation")
  )
```

### Declaración real de actividad

```{r read-est-ext.real}
est_real <- readRDS(awd("out/analysis/did_yearly_ext.real_S2.bal.ctrl.RDS"))
colnames <- est_real |> lapply(\(x) x$DIDparams$yname) |> unlist()
names(est_real) <- colnames
```

Por último, en esta subsección analizo el impacto de recibir e-facturas sobre la probabilidad de que las firmas pasen a hacer una declaración real de ingresos. El pasaje de un tipo de declaración a otra está relacionado con el diseño escalonado y el salto discreto en la deuda tributaria de las firmas al superar un cierto umbral de facturación cuando realizan una declaración ficta. En tal caso, cambiar el tipo de declaración puede resultar más redituable para las firmas.

Para explorar este margen de respuesta, selecciono una muestra balanceada de firmas que presentaban declaraciones fictas en 2009–2011, y permito que en algún momento después del tratamiento puedan pasar a presentar declaraciones reales. En primer lugar, realizo un test de Wald de significación conjunta de los estimandos pre-tratamiento y no rechazo que sean iguales a cero[^wald-real]. En otras palabras, las firmas tratadas tempranamente y las firmas tratadas tardíamente no diferían en la probabilidad de pasar a realizar declaraciones reales antes de empezar a recibir e-facturas.

[^wald-real]: P-valor del test: `r est_real$djReal$Wpval`

La @tbl-ext.real-overall-att presenta el efecto agregado sobre la probabilidad de presentar una declaración real. Se observa que la recepción de e-facturas se asocia con un aumento de 1.5 puntos porcentuales en la probabildad de presentar DJ real. Por otro lado, la @fig-ext.real-dynamic muestra los efectos de tratamiento dinámicos respecto al año en que la firma comienza recibir e-facturas. Se observa que el efecto es creciente en el tiempo y se vuelve significativo a partir del segundo año luego de recibir e-facturas.

```{r fig-ext.real-dynamic}
#| fig-cap: Efecto de e-factura sobre probabilidad de presentar DJ real.

tidy <- readRDS(awd("out/analysis/did_yearly_ext.real_S2.bal.ctrl_aggte.dynamic.RDS")) %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := as_factor(y.name)]
tidy %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2,
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks = -6:4) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.real-overall-att}
#| tbl-cap: Efecto de tratamiento agregado sobre probabilidad de presentar DJ real.

estlist <- readRDS(awd("out/analysis/did_yearly_ext.real_S2.bal.ctrl_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list)
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- str_flatten(colnames, collapse = "|")
tbl %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation")
  )
```

## Robustez

(Pendiente)