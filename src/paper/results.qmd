# Resultados

```{r lib-fcn}
library(groundhog)
pkgs <- c(
  "collapse",
  "data.table",
  "did",
  "fixest",
  "forcats",
  "fst",
  "ggplot2",
  "ggsci",
  "gtsummary",
  "kableExtra",
  "magrittr",
  "modelsummary",
  "purrr",
  "rlist",
  "stringr"
)
groundhog.library(pkgs, "2024-01-15")

ROOT <- ""
if (grepl("src/paper", getwd())) ROOT <- "../../"
awd <- \(x) paste0(ROOT, x)

source(paste0(ROOT, "src/lib/tidy_did.R"))
source(paste0(ROOT, "src/lib/theme_set.R"))
```

```{r read-estimates}
# estimation specifications
estname <- c("S1.bal.base", "S1.bal.ctrl", "S1.bal.wt", "S2.bal.base", "S3.unbal.base", "S3.unbal.wt")
# read simple overall att
filelist <- estname %>% paste0(ROOT, "out/analysis/did_yearly_", ., "_aggte.simple.RDS")
simple_est <- lapply(filelist, readRDS)
simple <- map(
  filelist,
  ~ .x %>%
    readRDS() %>%
    map(possibly(tidy_did, NULL)) %>%
    reduce(rbind) %>%
    setDT() %>%
    .[, variable := str_remove_all(y.name, "^Scaled[12]|K$") %>% as_factor()]
)
# read dynamic att
filelist <- str_replace(filelist, "simple", "dynamic")
dynamic_est <- map(filelist, readRDS)
dynamic <- map(
  filelist,
  ~ .x %>%
    readRDS() %>%
    map(possibly(tidy_did, NULL)) %>%
    reduce(rbind) %>%
    setDT() %>%
    .[, variable := str_remove_all(y.name, "^Scaled[12]|K$") %>% as_factor()]
)
# name estimations
names(simple) <- estname
names(dynamic) <- estname
names(simple_est) <- estname
names(dynamic_est) <- estname
# set data.table
walk(simple, setDT)
walk(dynamic, setDT)
# add column with specification name
walk2(simple, estname, ~ .x[, sample := .y])
walk2(dynamic, estname, ~ .x[, sample := .y])
```

```{r read-data}
samples <- read_fst(paste0(ROOT, "out/data/samples.fst"), as.data.table = TRUE)
dts <- 
  read_fst(awd("out/data/firms_static.fst"), as.data.table = TRUE) %>%
  .[samples[(activeBusinessAnyT)], on = "fid"]
dty <- 
  read_fst(awd("out/data/firms_yearly.fst"), as.data.table = TRUE) %>%
  .[samples[(activeBusinessAnyT)], on = "fid"]
dtycj <- 
  read_fst(awd("out/data/firms_yearly_filled.fst"), as.data.table = TRUE) %>% 
  .[samples[(activeBusinessAnyT)], on = "fid"]

size_quartiles <- dty[(inSample1), quantile(Scaler1, probs = seq(0, 1, 0.25), na.rm = TRUE)]
dty[(inSample1), sizeQuartile := cut(Scaler1, breaks = size_quartiles, labels = 1:4)]
```

## Resultados principales

### Recepción de e-facturas y costos reportados

En primer lugar, muestro evidencia en apoyo del supuesto de tendencias paralelas en los costos declarados, un requerimiento para la identificación en el diseño de diferencias en diferencias. La @fig-cost-dynamic presenta los efectos de tratamiento dinámicos propuestos por Callaway y Sant'Anna (2021), equivalentes a los estudios de eventos. Se observa que ninguno de los coeficientes es significativo antes del tratamiento. Si bien esto no confirma el supuesto de tendencias paralelas, si dota de mayor credibilidad al diseño seleccionado: indica que, en los años antes de recibir e-facturas, los costos reportados por tratados y controles venían evolucionando en paralelo.

Formalizo esta evidencia en la primera columna de la @tbl-main-overall-att, donde presento los efectos de tratamiento agregados. En conjunto, la recepción de e-facturas genera un aumento promedio en los costos reportados de \$0.032 por peso de facturación declarada en 2009–2010. En términos porcentuales respecto a la media pre-2011, representa un aumento de 5%.

```{r fig-cost-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre costos reportados
dynamic$S1.bal.base[y.name == "Scaled1deductPurchasesK"] %>%
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  labs(caption = "[ 95% Simult. CI ]")
```

```{r tbl-main-overall-att}
#| tbl-cap: Efecto de tratamiento agregado. Panel balanceado.
estlist <- simple_est$S1.bal.base
tbl <- estlist %>%
  map(possibly(tidy_did_list, NULL)) %>%
  list.filter(str_detect(tidy$y.name[[1]], "^Scaled1"))
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- str_remove_all(colnames, "^Scaled1|K$")
var_regex <- "deductPurchases|taxableTurnover|vatPurchases|vatSales|vatPaid"
ar <- data.frame(
  "Mean Y pre-2011",
  lapply(
    grep(var_regex, colnames, value = TRUE),
    \(x) dty[inSample1 & year <= 2011, fmean(get(x), na.rm = TRUE)]
  )
)
tbl %>%
  list.match(var_regex) %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation"),
    add_rows = ar
  )
```

### Recepción de e-facturas e ingresos reportados

En segundo lugar, exploro los ingresos reportados. Primero muestro los efectos de tratamiento dinámicos sobre el ingreso reportado, para aportar evidencia sobre el supuesto de tendencias paralelas en esta variable. No hay efectos significativos antes del tratamiento, ni tampoco después. 

En la segunda columna de la @tbl-main-overall-att muestro la estimación del efecto agregado promedio sobre los tratados. La estimación puntual es de \$0.107 por peso de facturación declarada en 2009–2010, pero no es significativa al 95%. 

```{r fig-revenue-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre ingresos reportados
dynamic$S1.bal.base[y.name == "Scaled1taxableTurnoverK"] %>%
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  labs(caption = "[ 95% Simult. CI ]")
```

### Recepción de e-facturas y pago de IVA

Por último analizo el pago anual de IVA, junto con IVA compras e IVA ventas declarados por las firmas. Cabe aclarar que aunque IVA compras e IVA ventas tienen un vínculo directo con costos y ventas reportados, respectivamente, dicho vínculo no es lineal. Hay productos y servicios que están sujetos a distintas tasas de IVA, lo cual crea no-linealidades en la relación entre IVA compras y costos (e IVA ventas e ingresos). Por otra parte, el IVA adeudado surge principalmente de la diferencia entre IVA ventas e IVA compras; pero la firma toma decisiones respecto a como afrontar esa deuda.

La @fig-vat-dynamic ilustra los efectos de tratamiento dinámicos sobre IVA compras (panel 1), IVA ventas (panel 2) y pago de IVA (panel 3). En ningún caso hay efectos significativos antes del tratamiento. Hay efectos significativos en el segundo período luego del tratamiento, tanto en IVA compras e IVA ventas.

Las últimas tres columnas de la @tbl-main-overall-att muestran el efecto agregado promedio sobre los tratados, para cada una de estas tres variables. La recepción de e-facturas tiene un impacto estadísticamente significativo de $0.008 por peso de facturación en 2009-2010. Representa un aumento de 6% en términos porcentuales. No hay efectos significativos sobre IVA ventas ni en pagos de IVA.

```{r fig-vat-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre componentes del IVA
dynamic$S1.bal.base[y.name %in% (c("vatSales", "vatPurchases", "vatPaid") %>% paste0("Scaled1", ., "K"))] %>%
  ggplot(aes(x = event, y = estimate)) +
  geom_point(size = 2) +
  # geom_line(size = 1) +
  # geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .3) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  facet_wrap(~variable, nrow = 3) +
  labs(caption = "[ 95% Simult. CI ]")
```

## Heterogeneidades

En esta sección analizo heterogeneidades en los efectos de tratamiento, de acuerdo al tamaño y al sector de las firmas. Presento en cada caso evidencia para apoyar el supuesto de tendencias paralelas, ya entre cuartiles de tamaño o entre sectores de actividad. Luego, muestro los efectos de tratamiento agregados, por sector y por tamaño de la firma.

### Heterogeneidad por tamaño de las firmas

Defino cuartiles de facturación pre-tratamiento para las firmas de la muestra principal. Las firmas del primer cuartil tienen una facturación pre-tratamiento menor a \$`r (size_quartiles[2] / 1e6) |> round(digits = 1)`M y las del cuarto cuartil una facturación superior a \$`r (size_quartiles[4] / 1e6) |> round(digits = 1)`M. Las @fig-heterog-size-dynamic-1, @fig-heterog-size-dynamic-2 muestran los efectos de tratamiento dinámicos para cada una de las variables analizadas en la sección anterior. En términos generales, prácticamente ninguno de los coeficientes pre-tratamiento resulta significativo. 

La @fig-heterog-size-overall sintetiza las estimaciones de los efectos agregados de tratamiento por cuartil. Los únicos efectos significativos se concentran en el primer cuartil, en los costos reportados e IVA compras. 

```{r fig-heterog-size-overall}
#| fig-cap: Efecto de tratamiento agregado por cuartiles de facturación pre-tratamiento. Panel balanceado.
simple_size <- readRDS(paste0(ROOT, "out/analysis/did_yearly_by.size_S1.bal.base_aggte.simple.RDS"))

tidy_size <- simple_size %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := str_remove_all(y.name, "^Scaled1|K$") %>%
    as_factor() %>%
    fct_rev()]

quantlist <- 1:4
nvars <- tidy_size[, .N, y.name] %>%
  dim() %>%
  .[1]
tidy_size[, sizeQuartile := rep(quantlist, nvars) %>% as_factor()]

varlist <- c("deductPurchases", "taxableTurnover", "vatPurchases", "vatSales", "vatPaid")
tidy_size[variable %in% varlist] %>%
  ggplot(aes(x = estimate, y = variable, color = sizeQuartile)) +
  geom_point(
    size = 2,
    position = position_dodge(width = .5)
  ) +
  geom_errorbarh(
    aes(
      xmin = conf.low,
      xmax = conf.high
    ),
    height = .5,
    position = position_dodge(width = .5)
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed"
  ) +
  coord_cartesian(xlim = c(-0.05, 0.5)) +
  ggsci::scale_color_futurama() +
  labs(y = NULL, color = "Pre-treatment size quartile")
```

### Heterogeneidad por sector de actividad

Al realizar las estimaciones por sector de actividad, los resultados no son tan claros. Todos los coeficientes dejan de ser significativos. Puede estar relacionado con la reducción en el número de observaciones utilizadas para cada una de las estimaciones.

```{r fig-heterog-industry-overall}
simple_ind <- readRDS(paste0(ROOT, "out/analysis/did_yearly_by.industry_S1.bal.base_aggte.simple.RDS"))

tidy_ind <- simple_ind %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := str_remove_all(y.name, "^Scaled1|K$") %>%
    as_factor()]

industrylist <- c("Construction", "Services", "Retail trade", "Manufacturing", "Wholesale", "Primary activities")
nvars <- tidy_ind[, .N, y.name] %>%
  dim() %>%
  .[1]
tidy_ind[, sector := rep(industrylist, nvars) %>% as_factor()]

p1 <- tidy_ind[variable %in% c("deductPurchases", "taxableTurnover", "vatPurchases", "vatSales", "vatPaid")] %>%
  ggplot(aes(x = estimate, y = sector, color = variable)) +
  geom_point(
    size = 2,
    position = position_dodge(width = .5)
  ) +
  geom_errorbarh(
    aes(
      xmin = conf.low,
      xmax = conf.high
    ),
    height = .5,
    position = position_dodge(width = .5)
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed"
  ) +
  xlim(-0.3, 0.66) +
  ggsci::scale_color_flatui() +
  labs(y = NULL, color = NULL)

# Add number of observations per industry
industrylist <- c("Construction", "Services", "Retail trade", "Manufacturing", "Wholesale", "Primary activities")
dty[sector == "Agriculture, forestry, fishing, mining and quarrying", sector := "Primary activities"]
nobs <- dty[(inSample1) & sector %in% industrylist, .N, sector] %>% 
  .[, estimate := .6] %>% 
  .[, label := paste0("N = ", N)]

p1 +
  geom_text(data = nobs, aes(label = label), color = "black")
```

## Margen extensivo

En esta sección presento evidencia sobre los efectos de la recepción de e-facturas en el margen extensivo. Estudio salidas de la muestra, cambios en la franja de renta ficta de IRAE, y cambios de declaraciones fictas a declaraciones reales de la actividad de la firma. Aplico el diseño de @callawayDifferenceinDifferencesMultipleTime2021 utilizando variables dependientes binarias para aproximarnos a las probabilidades de los eventos mencionados. Utilizo distintas muestras en cada subsección, detallando las diferencias en cada caso.

### Salidas

En primer lugar, estudio el impacto de la recepción de e-facturas sobre las salidas de las firmas de los registros tributarios. Para ello cambio la muestra: utilizo un panel de firmas balanceado en el período antes del primer tratamiento, pero permito salidas luego del inicio del tratamiento. Balanceo el panel artificialmente, de forma que las firmas aparezcan en todos los períodos a pesar de su salida. Luego cuantifico el impacto de la recepción de e-facturas sobre la probabilidad de que la firma registre distintos tipos de actividad con la autoridad tributaria. Considero como variables dependientes las probabilidades de pago de IVA, IRAE, y otros impuestos, la probabilidad de pagar algún impuesto, y la probabilidad de aparecer en alguno de los registros de DGI disponibles. 

La @fig-survival-dynamic muestra los efectos de tratamiento dinámicos para cada una de las variables mencionadas, para testear las tendencias paralelas antes del tratamiento. Ninguno de los coeficientes pre-tratamiento resulta significativo excepto el asociado a un año antes del tratamiento, lo cual podría estar indicando algún tipo de anticipación de las firmas. El método de @callawayDifferenceinDifferencesMultipleTime2021 contempla la posibilidad de que las firmas se anticipen al tratamiento, por lo que incluyo en todas las especificaciones de esta sección la posibilidad que las firmas se anticipen un período al tratamiento. 

La @tbl-survival-overall-att formaliza la evidencia gráfica y presenta los efectos agregados de tratamiento sobre cada una de las probabilidades mencionadas. Se observa que la recepción de e-facturas tiene un impacto negativo y significativo sobre la supervivencia (formal) de las firmas: reduce, en promedio, 2.7 puntos porcentuales la probabilidad de aparecer en los registros de la DGI. Cabe aclarar que esto no quiere decir que la firma desaparezca, sino que también es posible que pase a operar en la informalidad total.

El impacto es cuantitativamente similar sobre el pago total de impuestos. No obstante, aparecen diferencias importantes en la probabilidad de pago de los distintos tipos de impuestos. El pago de impuesto que menos se reduce es el IRAE, lo cual podría parecer contraintuitivo si se considera probable que las firmas salientes presenten resultados negativos al menos algún año antes de salir del mercado. Sin embargo, tener un resultado negativo no exonera a las firma de esta muestra del pago de IRAE, sino que pagan por una renta ficta calculada a partir de sus ingresos reportados. 

Por otra parte, hay reducciones importantes en la probabilidad de pagar IVA y otros impuestos, de 9.8 y 16 puntos porcentuales, respectivamente. Son reducciones considerables, más considerando la probabilidad de pagar estos impuestos antes del inicio del tratamiento: corresponden a reducciones de 12% y 18%, respectivamente. 

```{r fig-ext.survival-dynamic}
est_dyn_survival <- readRDS(paste0(ROOT, "out/analysis/did_yearly_ext.survival_S3.bal.base_aggte.dynamic.RDS"))
tidy <- est_dyn_survival %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>% 
  .[, variable := as_factor(y.name)]

tidy %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2, 
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks = -5:4) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.survival-overall-att}
#| tbl-cap: Efecto de tratamiento agregado sobre probabilidad de supervivencia. Panel balanceado.
estlist <- readRDS(awd("out/analysis/did_yearly_ext.survival_S3.bal.base_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list) %>% 
  .[c(5, 1:4)]
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- str_flatten(colnames, collapse = "|")
ar <- data.frame(
  "Mean Y pre-2011",
  lapply(
    grep(var_regex, colnames, value = TRUE),
    \(x) dtycj[inSample3 & year %in% 2010:2011, fmean(get(x), na.rm = TRUE)]
  )
)
tbl %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation"),
    add_rows = ar
  )
```

### Cambios de franja de renta ficta

Como ya mencioné, utilizo una muestra de firmas que presentan declaraciones fictas de actividad, en las cuales reportan únicamente sus ingresos. Luego, la DGI adjudica a las firmas una ganancia ficta y aplica sobre esta una tasa de 25% para calcular el IRAE adeudado. Una consecuencia de esto, como se observaba en la subsección anterior, es que este subconjunto de firmas reporta implícitamente ganancias en todos los períodos –y paga IRAE por estos–.

La renta ficta no se calcula de forma lineal. La tasa de rentabilidad ficta varía por tramos de facturación: para las firmas que facturan menos de 2M de UI es de 13.2%, para las que facturan entre 2M y 3M de UI es de 36%, y para las que facturan más de 3M de UI es de 48%. El régimen busca incentivar a las firmas a hacer declaraciones reales de su actividad luego de que superan cierto volumen de facturación.

El diseño, sin embargo, genera saltos discretos importantes en los pagos de las firmas. Para ilustrar, en el márgen, una firma que factura 1:999.999 UI debería pagar 66.000 UI por IRAE, mientras que facturando 2:000.001 UI pasaría a pagar 180.000 UI, casi triplicando su deuda tributaria. Es esperable que las firmas respondan a estos incentivos y la @fig-dens-trunover-fict muestra que lo hacen, concentrando sus declaraciones justo por debajo y por encima del punto de corte de 2M UI. [^bunch_excede]

[^bunch_excede]: Si bien podríamos explotar esta discontinuidad con un diseño de *bunching*, hacerlo excede el alcance actual de este trabajo.

En esta subsección, exploro si la recepción de e-facturas tiene un impacto suficientemente fuerte como para empujar a las firmas a cambiar de tramo de declaración. Primero, presento evidencia que apoye el supuesto de tendencias paralelas en la probabilidad de cambiar de tramo de renta ficta (@fig-ext.bracket-dynamic). Testeo el cambio de tramo con cuatro especificaciones, utilizando (i) la probabilidad de pasar del primer al segundo tramo de renta ficta; (ii) la probabilidad de pasar a un tramo mayor de un período al siguiente; (iii) la probabilidad de pasar a un tramo menor de un período al siguiente; y (iv) la probabilidad de cambiar de tramo, independientemente de si implica una mayor o menor deuda tributaria. Ninguno de los coeficientes pre- ni post- tratamiento es significativamente distinto de cero al 95%.

La @tbl-ext.bracket-overall-att presenta los efectos de tratamiento agregados. Nuevamente, ninguno de los coeficientes resulta estadísticamente significativo. En otras palabras, la recepción de e-facturas no parece tener un efecto de suficiente magnitud sobre el ingreso reportado como para llevar a las firmas a cambiar de tramo de facturación. El resultado es coherente con lo hallado al analizar el ingreso reportado, ya que tampoco aparecían efectos significativos de la e-factura sobre dicha variable en términos continuos.

```{r fig-ext.bracket-dynamic}
#| fig-cap: Efecto dinámico de la recepción de e-factura sobre probabilidad de cambiar de franja de renta ficta.
est_dyn <- readRDS(awd("out/analysis/did_yearly_ext.bracket_S1.bal.base_aggte.dynamic.RDS"))
tidy <- est_dyn %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := as_factor(y.name)]
tidy[str_detect(variable, "bracketShift|bracket1to2")] %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2,
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks  = -6:4, ) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.bracket-overall-att}
#| tbl-cap: Efecto de tratamiento agregado sobre probabilidad de cambiar de franja de renta ficta.
estlist <- readRDS(awd("out/analysis/did_yearly_ext.bracket_S1.bal.base_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list)
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- "bracketShift|bracket1to2"
tbl %>%
  list.match(var_regex) %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation")
  )
```

### Declaración real de actividad

Por último, en esta subsección analizo el impacto de recibir e-facturas sobre la probabilidad de que las firmas pasen a hacer una declaración de ingresos. Para ello, tomo una muestra balanceada de firmas que presentaban declaraciones fictas antes del primer período de tratamiento, y permito que en algún momento después del tratamiento pudan pasar a presentar declaraciones reales.

La @fig-ext.real-dynamic muestra los efectos de tratamiento dinámicos para la probabilidad de presentar una declaración real de actividad. Al igual que con el pago de impuestos, hay anticipación al tratamiento de un período, lo cual incorporo en la especificación. La @tbl-ext.real-overall-att formaliza la evidencia gráfica e indica que, en el agregado, la recepción de e-facturas se asocia con un aumento de 6.6 puntos porcentuales en la probabildad de presentar DJ real.

```{r fig-ext.real-dynamic}
#| fig-cap: Efecto de e-factura sobre probabilidad de presentar DJ real.

tidy <- readRDS(awd("out/analysis/did_yearly_ext.real_S2.bal.base_aggte.dynamic.RDS")) %>%
  map(possibly(tidy_did, NULL)) %>%
  reduce(rbind) %>%
  setDT() %>%
  .[, variable := as_factor(y.name)]
tidy %>%
  ggplot(aes(x = event, y = estimate, color = variable)) +
  geom_point(size = 2, position = position_dodge(width = .5)) +
  geom_errorbar(
    aes(
      ymin = conf.low,
      ymax = conf.high
    ),
    width = .2,
    position = position_dodge(width = .5)
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "maroon") +
  geom_vline(xintercept = -.5, linetype = "dashed") +
  scale_x_continuous(breaks = -6:4) +
  ggsci::scale_color_d3() +
  labs(color = NULL, caption = "[ 95% Simult. CI ]") +
  theme(panel.grid.major.x = element_blank())
```

```{r tbl-ext.real-overall-att}
#| tbl-cap: Efecto de tratamiento agregado sobre probabilidad de presentar DJ real.

estlist <- readRDS(awd("out/analysis/did_yearly_ext.real_S2.bal.base_aggte.simple.RDS"))
tbl <- estlist %>%
  map(tidy_did_list)
colnames <- list.cases(tbl, tidy$y.name, sorted = FALSE)
names(tbl) <- colnames
var_regex <- str_flatten(colnames, collapse = "|")
tbl %>%
  msummary(
    statistic = "conf.int",
    gof_map = c("nobs", "clustervars", "panel.balanced", "control.group", "anticipation")
  )
```


## Robustez
