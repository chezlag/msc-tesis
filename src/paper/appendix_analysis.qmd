# Análisis adicionales
```{r lib-fcn}
library(groundhog)
pkgs <- c(
  "data.table",
  "did",
  "fixest",
  "forcats",
  "fst",
  "ggplot2",
  "ggsci",
  "gtsummary",
  "kableExtra",
  "magrittr",
  "modelsummary",
  "purrr",
  "rlist",
  "stringr"
)
groundhog.library(pkgs, "2024-01-15")

ROOT <- ""
if (grepl("src/paper", getwd())) ROOT <- "../../"

source(paste0(ROOT, "src/lib/tidy_did.R"))
source(paste0(ROOT, "src/lib/theme_set.R"))
```

```{r read-data-appendix}
samples <- read_fst(paste0(ROOT, "out/data/samples.fst"), as.data.table = TRUE)
dty <- read_fst(paste0(ROOT, "out/data/firms_yearly.fst"), as.data.table = TRUE) %>%
  .[samples[(in214AnyT | in217AnyT)], on = "fid"]
dts <- read_fst(paste0(ROOT, "out/data/firms_static.fst"), as.data.table = TRUE) %>%
  .[samples[(in214AnyT | in217AnyT)], on = "fid"]
# fix sample NAs
walk(paste0("inSample", 0:2), ~ dts[is.na(get(.x)), (.x) := FALSE])
walk(paste0("inSample", 0:2), ~ dty[is.na(get(.x)), (.x) := FALSE])
dts[, neverTreated := is.na(nonAbsorbing)]
dty[, neverTreated := is.na(nonAbsorbing)]
```

```{r}
#| label: fig-dens-trunover-fict
#| fig-cap: Facturación reportada en millones de UI, por tipo de declaración.
dty[turnoverMUI %between% c(0.01, 30)] |>
  ggplot(aes(x = turnoverMUI, color = djFict, fill = djFict)) +
  geom_density(linewidth = 1, alpha = 0.3) +
  geom_vline(xintercept = 3, size = 1) +
  geom_vline(xintercept = 2, size = 1.5) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0.01, 5)) +
  ggsci::scale_color_cosmic() +
  ggsci::scale_fill_cosmic() +
  labs(
    x = "Facturación en millones de UI", y = "Densidad",
    color = "DJ Ficta", fill = "DJ Ficta"
  )
```

```{r}
#| label: tbl-static-characteristics-desgranamiento
#| tbl-cap: Descriptivas de panel balanceado y no balanceado (1 obs. = 1 firma).

varlist <- c(
  "inSample1",
  "receivedAnyT",
  "emittedAnyT",
  "neverTreated",
  "sector"
)
dts[inSample0 & djFictAnyT, ..varlist] %>%
  tbl_summary(by = "inSample1", missing = "no") %>%
  add_p()
```

```{r}
#| label: tbl-yearly-characteristics-desgranamiento
#| tbl-cap: Descriptivas de panel balanceado y no balanceado (1 obs. = 1 año-firma).

varlist <- c(
  "inSample1",
  "Scaler1",
  "Scaled1deductPurchasesK",
  "Scaled1RevenueK",
  "Scaled1taxableTurnoverK",
  "Scaled1vatSalesK",
  "Scaled1vatPurchasesK",
  "Scaled1vatDueK",
  "Scaled1vatPaidK",
  "Scaled1corpTaxPaidK",
  "Scaled1otherTaxPaidK",
  "Scaled1totalTaxPaidK"
)
dty[inSample0 & djFict & year %in% 2009:2015, ..varlist] %>%
  .[, Scaler1 := Scaler1 / 1e06] %>%
  tbl_summary(
    by = "inSample1",
    # statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing = "no",
  ) %>%
  add_p()
```

```{r}
#| label: fig-dens-turnover-nevertreated
#| fig-cap: Facturación reportada en millones de UI, por estado de tratamiento. Muestra principal.
dty[inSample1 & turnoverMUI %between% c(0.01, 30)] |>
  ggplot(aes(x = turnoverMUI, color = neverTreated, fill = neverTreated)) +
  geom_density(linewidth = 1, alpha = 0.3) +
  geom_vline(xintercept = 3, size = 1) +
  geom_vline(xintercept = 2, size = 1.5) +
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0.01, 5)) +
  ggsci::scale_color_cosmic() +
  ggsci::scale_fill_cosmic() +
  labs(
    x = "Facturación en millones de UI", y = "Densidad",
    color = "Never-treated", fill = "Never-treated"
  )
```

```{r }
#| label: tbl-yearly-characteristics-nevertreated
#| tbl-cap: Descriptivas de nunca tratados. Muestra principal. (1 obs. = 1 año-firma).

varlist <- c(
  "neverTreated",
  "Scaler1",
  "Scaled1deductPurchasesK",
  "Scaled1RevenueK",
  "Scaled1taxableTurnoverK",
  "Scaled1vatSalesK",
  "Scaled1vatPurchasesK",
  "Scaled1vatDueK",
  "Scaled1vatPaidK",
  "Scaled1corpTaxPaidK",
  "Scaled1otherTaxPaidK",
  "Scaled1totalTaxPaidK"
)
dty[inSample1 & djFict & year %in% 2009:2015, ..varlist] %>%
  .[, Scaler1 := Scaler1 / 1e06] %>%
  tbl_summary(
    by = "neverTreated",
    # statistic = list(all_continuous() ~ "{mean} ({sd})"),
    missing = "no",
  ) %>%
  add_p()
```

```{r}
#| label: fig-bunching-event
#| fig-cap: Facturación anual reportada el año antes y el año después de recibir la primera factura electrónica. Muestra principal.
dty[, eventtime := year - yearFirstReception]
dty[, .N, eventtime]
dty[turnoverMUI < 5 & inSample1 & eventtime %in% c(-1, 1)] |>
  ggplot(aes(turnoverMUI, color = as.factor(eventtime))) +
  geom_density(linewidth = 1) +
  coord_cartesian(xlim = c(0, 5)) +
  ggsci::scale_color_cosmic() +
  geom_vline(xintercept = 2, linetype = "dashed") +
  geom_vline(xintercept = 3, linetype = "dashed") +
  labs(color = "Event time", x = "Facturación en millones de UI")
```

